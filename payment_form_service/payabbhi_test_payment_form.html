<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <meta content="" name="description">
  <title>Dummy Payabbhi payment form</title>
  <link rel="stylesheet" media="all" href="https://payabbhi.com/pages/assets/pages.css">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"
    id="bootstrap-css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,700" rel="stylesheet">
  <style>
    body {
      /* main reason for transparent iframe */
      background: none transparent;
    }

    #phb-button {
      background: #009aa5 ! important;
      text-transform: uppercase;
      color: white;
      font-family: "Montserrat ";
      filter: drop-shadow (0 0 2 .82mm rgba (0, 0, 0, 0 .25));
    }

    .required:after {
      content: " *";
      color: red;
    }

    .custom-modal {
      width: 350px;
      height: 300px;
    }

    .my-input {
      outline: 0;
      border-width: 0 0 2px;
      border-color: blue;
    }

    .my-input:focus {
      border-color: green
    }
  </style>
</head>

<body>
  <div class="modal fade" id="demoModal">
    <div class="modal-dialog modal-dialog-centered custom-modal">
      <div class="modal-content">
        <div class="modal-body p-0" id="demo-modal-body">
          <div class="container p-0" style="font-family: 'Josefin Sans', sans-serif; font-size: 15px;">
            <div class="row">
              <div class="col-sm">
                <div class="card">
                  <div class="card-header d-flex justify-content-between" id="modal-header">
                    <div>Payment Information</div>
                    <div>
                      <button type="button" class="close" id="close-btn" data-dismiss="modal">
                        <span>&times;</span>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <form id="payment-page-form" class="needs-validation" novalidate=""
                      style="overflow-y:auto;height:250px; ">
                      <div class="form-group">
                        <label class="required">Amount (â‚¹)</label>
                        <div>
                          <div>
                            <input class="form-control my-input" type="text" id="customer-defined-amount"
                              pattern="^[1-9][0-9]*([.][0-9]{1,2})?$" required="">
                            <div class="invalid-feedback">Please provide valid amount</div>
                          </div>
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Name</label>
                        <div>
                          <input class="form-control my-input" type="text" id="name"
                            style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAfBJREFUWAntVk1OwkAUZkoDKza4Utm61iP0AqyIDXahN2BjwiHYGU+gizap4QDuegWN7lyCbMSlCQjU7yO0TOlAi6GwgJc0fT/fzPfmzet0crmD7HsFBAvQbrcrw+Gw5fu+AfOYvgylJ4TwCoVCs1ardYTruqfj8fgV5OUMSVVT93VdP9dAzpVvm5wJHZFbg2LQ2pEYOlZ/oiDvwNcsFoseY4PBwMCrhaeCJyKWZU37KOJcYdi27QdhcuuBIb073BvTNL8ln4NeeR6NRi/wxZKQcGurQs5oNhqLshzVTMBewW/LMU3TTNlO0ieTiStjYhUIyi6DAp0xbEdgTt+LE0aCKQw24U4llsCs4ZRJrYopB6RwqnpA1YQ5NGFZ1YQ41Z5S8IQQdP5laEBRJcD4Vj5DEsW2gE6s6g3d/YP/g+BDnT7GNi2qCjTwGd6riBzHaaCEd3Js01vwCPIbmWBRx1nwAN/1ov+/drgFWIlfKpVukyYihtgkXNp4mABK+1GtVr+SBhJDbBIubVw+Cd/TDgKO2DPiN3YUo6y/nDCNEIsqTKH1en2tcwA9FKEItyDi3aIh8Gl1sRrVnSDzNFDJT1bAy5xpOYGn5fP5JuL95ZjMIn1ya7j5dPGfv0A5eAnpZUY3n5jXcoec5J67D9q+VuAPM47D3XaSeL4AAAAASUVORK5CYII=&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%;">
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="required">Email</label>
                        <div>
                          <input class="form-control my-input" type="email" id="email"
                            pattern="^(([^<>()[\]\\.,;:\s@]+(\.[^<>()[\]\\.,;:\s@]+)*)|(.+))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$"
                            required="">
                          <div class="invalid-feedback">Please provide valid email</div>
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="required">Phone</label>
                        <div>
                          <input class="form-control my-input" type="tel" id="contact" pattern="^[+]?[0-9]{10,15}$"
                            required="">
                          <div class="invalid-feedback">Please provide valid phone no</div>
                        </div>
                      </div>

                    </form>
                  </div>
                  <div class="card-footer text-muted">
                    <img class="icon" src="https://payabbhi.com/pages/assets/visa.png"> <img class="icon"
                      src="https://payabbhi.com/pages/assets/mastercard.png"> <img class="icon"
                      src="https://payabbhi.com/pages/assets/amex.png"> <img class="icon"
                      src="https://payabbhi.com/pages/assets/upi.png"> <img class="icon"
                      src="https://payabbhi.com/pages/assets/nb.png">
                    <button class="btn btn-primary float-right" id="phb-button">Next</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- <script src="http://localhost:3035/checkout.js" type="text/javascript"></script> -->
  <script src="https://checkout.payabbhi.com/v1/checkout.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://payabbhi.com/pages/assets/pages.js" type="text/javascript"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script>
    /*<![CDATA[*/
    const customer_fields = [];
    const amount = 0;
    const access_id = "id_test_-5SZ3kc-QWCABN681ojo9yQBw0vsH-v_uxmLW0ZHjUk=";
    const payment_page_id = "page_0WyENStMxxpCG3Oj";
    const dynamic_host = "payabbhi.com";
    const business_display_name = "Mangalore City Corporation";
    const settings = { "customizedMessage": "", "returnUrl": "" };

    //for testing locally
    // const customer_fields = [{ "name": "1", "type": "number", "isMandatory": false, "helpText": "", "options": "[]" }];
    // const amount = 0;
    // const access_id = "id_test_33c83f6366ee4b8e878171e6923e8a6be92dd259cd2=";
    // const payment_page_id = "page_siZ23B0oq2s83zT6";
    // const dynamic_host = "payscape.in";
    // const business_display_name = "Test Book Store";
    // const settings = { "customizedMessage": "", "returnUrl": "" };
    /*]]>*/
  </script>
  <script>
    const createNotes = function () {
      const notes = {};
      if ($("#name") !== undefined && $("#name").val() !== undefined) {
        notes["page_" + "Name"] = $("#name").val().trim();
      }
      customer_fields.forEach(function (customer_field, index) {
        if ($("#custom_field_" + index) !== undefined && $("#custom_field_" + index).val() !== undefined) {
          notes["page_" + customer_field["name"]] = $("#custom_field_" + index).val().trim();
        }
      });
      return notes;
    }
    const getAmount = function () {
      if ($('#customer-defined-amount') !== undefined && $('#customer-defined-amount').val() !== undefined) {
        return $('#customer-defined-amount').val().trim() * 100;
      }
      return amount;
    }
    const getConfirmationHtml = (response) => {
      const customizedMessage = settings["customizedMessage"];
      const successImage = `https://${dynamic_host}/pages/assets/success.png`;

      const name = $('#name').val().trim().length != 0
        ? `<div class="row">
            <label class="col-sm-5 text-right">Name:</label>
              <label class="col-sm-7">${$('#name').val().trim()}</label>
            </div>`
        : '';

      return `<div class="card border border-success">
              <div class="card-body">
                <div class="row text-center">
                  <div class="col col-form-label">Your payment was successful</div>
                </div>
                <div class="row">
                  <label class="col-sm-5 text-right">Payment ID:</label>
                  <label class="col-sm-7">${response.payment_id}</label>
                </div>
                <div class="row">
                  <label class="col-sm-5 text-right">Amount:</label> \
                  <label class="col-sm-7">${(getAmount() / 100).toFixed(2)}</label>
                </div>
                ${name}
                <div class="row">
                  <label class="col-sm-5 text-right">Email:</label>
                  <label class="col-sm-7">${$('#email').val().trim()}</label>
                </div>
                <div class="row">
                  <label class="col-sm-5 text-right">Contact:</label>
                  <label class="col-sm-7">${$('#contact').val().trim()}</label>
                </div>
                <div class="row col-form-label text-center">
                  <div class="col col-form-label">${customizedMessage}</div>
                </div>
                <div class="row text-center">
                  <img src="${successImage}" style="width: 92px;" class="mx-auto" />
                </div>
              </div>
              <div class="card-footer p-0">
                <button type="button"
                  class="btn btn-outline-success btn-lg btn-block rounded-0 border-left-0 border-right-0 border-bottom-0"
                  onclick="onDoneBtnClick()">Done</button>
              </div>
            </div>`;


    };
    $(document).ready(function () {
      customer_fields.forEach(function (value, index) {
        if (value["type"] === "dropdown") {
          const opts = JSON.parse(value["options"]);
          opts.forEach(function (val, i) {
            const option = new Option(val, val);
            $("#custom_field_" + index).append($(option));
          })
        }
      });
      $('#phb-button').click(function (e) {
        const form = document.forms['payment-page-form'];
        const isFormValid = form.checkValidity();
        if (isFormValid) {
          const options = {
            "access_id": access_id,
            "payment_page_id": payment_page_id,
            "currency": "INR",
            "amount": getAmount(),
            "name": business_display_name,
            "notes": createNotes(),
            "prefill": {
              "name": $('#name').val().trim(),
              "email": $('#email').val().trim(),
              "contact": $('#contact').val().trim()
            },
            "handler": function (response) {
              $("#demo-modal-body").html(getConfirmationHtml(response));
              $("#demoModal").modal('show');
            }
          };
          const payabbhi = new Payabbhi(options);
          $("#demoModal").modal('hide');
          payabbhi.open();
          e.preventDefault();
        } else {
          event.preventDefault();
          event.stopPropagation();
          form.classList.add('was-validated');
        }
      });
    });
  </script>
  <script>
    $("#demoModal").modal({
      backdrop: 'static',
      keyboard: false
    });
    $('#close-btn').on('click', function (e) {
      e.preventDefault();
      confirm("Are you sure!") ? parent.postMessage("closePaymentFormIframe", "*") : e.stopPropagation();
    });
    // $('#close-btn').on('click', (e) => {
    //   console.log("close btn clicked")
    //   e.preventDefault();
    //   swal({
    //     title: "Are you sure?",
    //     // text: "Once deleted, you will not be able to recover this imaginary file!",
    //     icon: "warning",
    //     buttons: true,
    //     dangerMode: true,
    //   })
    //     .then((willDelete) => {
    //       if (willDelete) {
    //         parent.postMessage("closePaymentFormIframe", "*")
    //       } else {
    //         e.stopPropagation();
    //       }
    //     });
    // });
    const onDoneBtnClick = function () {
      parent.postMessage("closePaymentConfirmationIframe", "*");
    };
  </script>
  <script>

    const payabbhiCheckoutClosed = function () {
      $("#demoModal").modal('show');
    }

    window.addEventListener("message", (event) => {
      const data = event.data;
      if (data === 'payabbhiCheckoutClosed') {
        console.log("inside payment form : payabbhiCheckoutClosed:", data);
        console.log("inside payment form : event.origin:", event.origin);
        payabbhiCheckoutClosed();
      }
    });
  </script>

</body>

</html>